<!DOCTYPE html>
<!-- duotecno.be - Author: VJ -->
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link href="build/toastr.css" rel="stylesheet" type="text/css" />
    <title>Duotecno - Digital Meter Configuration</title>
</head>

<body>

    <div class="header">
        <div class="logo-container">
            <img src="dt_logo.png" class="logo">
            <h1 class="page-title">Digital Meter Configuration</h1>
        </div>
        <div class="navbar">
            <a href="/" class="navbar-item">Home</a>
            <a href="#" class="navbar-item">Configuration</a>
            <a href="triggers" class="navbar-item">Triggers</a>
            <!--<a href="test" class="navbar-item">Test</a>-->
            <a href="logout" class="navbar-item">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2 class="card-title">Digital Meter</h2>

            <table class="active" id="table1">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>Register</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Current consumption</td>
                        <td><span class="label green">%P1_CONSUMPTION% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_1%"></td>
                    </tr>

                    <tr>
                        <td>Current injection</td>
                        <td><span class="label green">%P1_R_CONSUMPTION% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_2%"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Consumption (today)</td>
                        <td><span class="label dark-yellow">%P1_CONSUMPTION_TODAY% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_3%"></td>
                    </tr>

                    <tr>
                        <td>Consumption (yesterday)</td>
                        <td><span class="label dark-yellow">%P1_CONSUMPTION_YDAY% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_4%"></td>
                    </tr>

                    <tr>
                        <td>Injection (today)</td>
                        <td><span class="label dark-yellow">%P1_INJECTION_TODAY% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_5%"></td>
                    </tr>
                    <tr>
                        <td>Injection (yesterday)</td>
                        <td><span class="label dark-yellow">%P1_INJECTION_YDAY% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_6%"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Tariff 1 (day) total consumption</td>
                        <td><span class="label green">%P1_CONSUMPTION_T1% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_7%"></td>
                    </tr>
                    <tr>
                        <td>Tariff 2 (night) total consumption</td>
                        <td><span class="label green">%P1_CONSUMPTION_T2% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_8%"></td>
                    </tr>
                    <tr>
                        <td>Total consumption</td>
                        <td><span class="label green">%P1_CONSUMPTION_TOTAL% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_9%"></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Tariff 1 (day) total injection</td>
                        <td><span class="label green">%P1_INJECTION_T1% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_10%"></td>
                    </tr>
                    <tr>
                        <td>Tariff 2 (night) total injection</td>
                        <td><span class="label green">%P1_INJECTION_T2% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_11%"></td>
                    </tr>
                    <tr>
                        <td>Total injection</td>
                        <td><span class="label green">%P1_INJECTION_TOTAL% kWh</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_12%"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Current Peek Power</td>
                        <td><span class="label dark-yellow">%P1_AVG_DEMAND% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_13%"></td>
                    </tr>

                    
                    <tr>
                        <td>Monthly Peek Power</td>
                        <td><span class="label dark-yellow">%P1_MONTH_AVG_DEMAND% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_14%"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>Gas - total usage</td>
                        <td><span class="label grey">%P1_GAS% m3</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_15%"></td>
                    </tr>

                    
                    <tr>
                        <td>Water - total usage</td>
                        <td><span class="label light-blue">%P1_WATER% m3</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_16%"></td>
                    </tr>
                </tbody>
            </table>

            <table id="table2">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Value</th>
                        <th>Register</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>L1 consumption</td>
                        <td><span class="label green">%P1_L1CONSUMPTION% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_17%"></td>
                    </tr>
                    <tr>
                        <td>L1 Voltage</td>
                        <td><span class="label green">%P1_L1VOLTAGE% V</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_18%"></td>
                    </tr>
                    <tr>
                        <td>L1 Current</td>
                        <td><span class="label green">%P1_L1CURRENT% A</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_19%"></td>
                    </tr>

                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>L2 consumption</td>
                        <td><span class="label green">%P1_L2CONSUMPTION% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_20%"></td>
                    </tr>
                    <tr>
                        <td>L2 Voltage</td>
                        <td><span class="label green">%P1_L2VOLTAGE% V</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_21%"></td>
                    </tr>
                    <tr>
                        <td>L2 Current</td>
                        <td><span class="label green">%P1_L2CURRENT% A</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_22%"></td>
                    </tr>
                    
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>

                    <tr>
                        <td>L3 consumption</td>
                        <td><span class="label green">%P1_L3CONSUMPTION% kW</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_23%"></td>
                    </tr>
                    <tr>
                        <td>L3 Voltage</td>
                        <td><span class="label green">%P1_L3VOLTAGE% V</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_24%"></td>
                    </tr>
                    <tr>
                        <td>L3 Current</td>
                        <td><span class="label green">%P1_L3CURRENT% A</span></td>
                        <td><input type="text" class="small-column" oninput="this.value = this.value.replace(/[^0-9-]/g, '');" maxlength="2" placeholder="0" value="%P1_DATA_25%"></td>
                    </tr>

                </tbody>
            </table>

            <button onclick="previousTable()" class="button centered-button"><</button>
            <button onclick="saveValues(0)" class="button centered-button">Save</button>
            <button onclick="nextTable()" class="button centered-button">></button>

            <div id="table-index-container" class="table-index-container"> <!-- Container for table index display -->
                <span id="table-index"></span> <!-- Span to display current table index -->
            </div>

            <p>
                <h5 style="font-size: 0.5"><i>Register: -1 = not used.</i></h5>
            </p>

            <h2 class="card-title">Registermap</h2>
            <div class="input-container">
                <label for="registerip" class="input-label">Master IP:</label>
                <input type="text1" id="registerip" name="registerip" class="input-field" value="%MASTERREGISTERIP%">
            </div>

            <p>
                <h5 style="font-size: 0.5"><i>Example: 0.0.0.0</i></h5>
            </p>
            <button onclick="saveValues(1)" class="button centered-button">Save</button>
        </div>

        <div class="card">
            <h2 class="card-title">Telegram Data</h2>
            <textarea class="input-box" readonly>%P1RAWDATA%</textarea>
        </div>
    </div>

    <script src="build/jquery.min.js"></script>
    <script src="build/toastr.js"></script>

    <script>
        toastr.options = {
            "closeButton": false,
            "debug": false,
            "newestOnTop": false,
            "progressBar": false,
            "positionClass": "toast-bottom-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }

        function saveValues(typeAction) {
            jsonBody = "";

            if (typeAction == 0) {
                const inputFields = document.querySelectorAll('input[type="text"]');
                const values = [];
                inputFields.forEach(input => {
                    values.push(input.value);
                });

                jsonBody = JSON.stringify({id: typeAction, values: values});
            } else if (typeAction == 1) {
                const registerInput = document.getElementById('registerip').value;

                jsonBody = JSON.stringify({id: typeAction, value: registerInput});
            } else {
                return;
            }

            // Send POST request with the values
            fetch('/registerdigitalmeter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonBody
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok. Please try again.');
                    return response.json();
                } else {
                    //alert("Saved successfully!");
                    toastr.success('Saved successfully!');
                    return;
                }
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
                toastr.error('Error saving. Please try again.');
            });
        }

        let tables; // Declare tables variable outside the event listener
        let currentTableIndex = 0;
        tables = document.querySelectorAll('table'); // Assign tables here
        
        //console.log("Tables:", tables);

        function showTable(index) {
            for (let i = 0; i < tables.length; i++) {
                if (i === index) {
                    tables[i].style.display = 'table';
                } else {
                    tables[i].style.display = 'none';
                }
            }

            document.getElementById('table-index').textContent = '(Page ' + (index + 1 + ')'); // Update table index display
        }

        function nextTable() {
            currentTableIndex++;
            if (currentTableIndex >= tables.length) {
                currentTableIndex = 0;
            }
            showTable(currentTableIndex);
        }

        function previousTable() {
            currentTableIndex--;
            if (currentTableIndex < 0) {
                currentTableIndex = tables.length - 1;
            }
            showTable(currentTableIndex);
        }

        showTable(currentTableIndex); // Show the initial table
       
    </script>
</body>

</html>